<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>1:1 채팅 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial; max-width:600px; margin:auto; padding:1em; }
        #roomsSection,#chatSection { display:none; }
        ul{list-style:none;padding:0;}
        li{padding:.5em;border-bottom:1px solid #ddd;cursor:pointer;}
        #chatArea{border:1px solid #ccc;height:300px;overflow-y:auto;padding:.5em;}
        .flex{display:flex;gap:.5em;}
        .flex input{flex:1;}
    </style>
</head>
<body>

<h1>1:1 채팅 테스트</h1>

<!-- 1) 로그인 -->
<div id="loginSection">
    <h2>로그인</h2>
    <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="이메일" required />
        <input type="password" id="loginPassword" placeholder="비밀번호" required />
        <button>로그인</button>
    </form>
    <div id="loginError" style="color:red;"></div>
</div>

<!-- 2) 채팅방 목록 -->
<div id="roomsSection">
    <h2>내 채팅방</h2>
    <ul id="roomsList"></ul>
    <h3>새 채팅 열기</h3>
    <div class="flex">
        <input type="email" id="newChatEmail" placeholder="상대 이메일" />
        <button id="newChatBtn">새 채팅</button>
    </div>
</div>

<!-- 3) 대화 화면 -->
<div id="chatSection">
    <button id="backBtn">← 목록으로</button>
    <h2 id="chatWith">대화 상대: </h2>
    <div id="chatArea"></div>
    <div class="flex">
        <input type="text" id="messageInput" placeholder="메시지…" />
        <button id="sendBtn">Send</button>
    </div>
</div>

<script>
    let stompClient, currentUserEmail, currentUserNick;
    let currentChatEmail, currentChatNick;

    const loginForm    = document.getElementById('loginForm');
    const loginError   = document.getElementById('loginError');
    const loginSection = document.getElementById('loginSection');
    const roomsSection = document.getElementById('roomsSection');
    const chatSection  = document.getElementById('chatSection');
    const roomsList    = document.getElementById('roomsList');
    const newChatBtn   = document.getElementById('newChatBtn');
    const newChatEmail = document.getElementById('newChatEmail');
    const backBtn      = document.getElementById('backBtn');
    const chatWith     = document.getElementById('chatWith');
    const chatArea     = document.getElementById('chatArea');
    const sendBtn      = document.getElementById('sendBtn');
    const msgInput     = document.getElementById('messageInput');

    // 1) 로그인
    loginForm.addEventListener('submit', async e => {
        e.preventDefault();
        loginError.textContent = '';
        const email = loginEmail.value.trim();
        const pwd   = loginPassword.value.trim();
        try {
            const res = await fetch('http://localhost:9090/public/users/login', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body: JSON.stringify({ email, password: pwd })
            });
            if(!res.ok) throw new Error(res.status);
            const data = await res.json();
            currentUserEmail = data.email;
            currentUserNick  = data.nickname || data.email;
            loginSection.style.display = 'none';
            roomsSection.style.display = 'block';
            connectWS();
            loadRooms();
        } catch(err) {
            loginError.textContent = '로그인 실패';
        }
    });

    // 2) 방 목록 로드
    async function loadRooms(){
        try {
            const res = await fetch('http://localhost:9090/private/chatrooms/user', { credentials:'include' });
            const list = await res.json();
            roomsList.innerHTML = '';
            list.forEach(r => {
                const li = document.createElement('li');
                li.textContent = `${r.otherNickName} — ${r.lastMessage||'-'} (${r.lastMessageTime||'-'})`;
                li.onclick = ()=> openChat(r.otherNickName, r.otherEmail);
                roomsList.appendChild(li);
            });
        } catch(e){ console.error(e) }
    }

    // 3) 새 채팅
    newChatBtn.onclick = () => {
        const email = newChatEmail.value.trim();
        if(!email) return alert('이메일 입력');
        openChat(email,email);
    }

    // 4) 채팅 열기
    async function openChat(nick,email){
        currentChatNick  = nick;
        currentChatEmail = email;
        roomsSection.style.display = 'none';
        chatSection.style.display  = 'block';
        chatWith.textContent = `대화 상대: ${nick}`;
        chatArea.innerHTML = '';

        // 이전 대화
        try {
            const res = await fetch(
                `http://localhost:9090/private/chatrooms/history?user1=${encodeURIComponent(currentUserEmail)}&user2=${encodeURIComponent(email)}`,
                { credentials:'include' }
            );
            const hist = await res.json();
            hist.forEach(m=>{
                // m.sender은 이메일, m.content는 메시지
                const who = m.sender===currentUserEmail ? currentUserNick : currentChatNick;
                showMsg(who, m.content);
            });
        } catch(e){ console.error(e) }
    }

    // 5) 뒤로
    backBtn.onclick = ()=>{
        chatSection.style.display='none';
        roomsSection.style.display='block';
        currentChatEmail = null;
    }

    // 6) WS 연결
    function connectWS(){
        const sock = new SockJS('http://localhost:9090/ws',null,{
            transports:['websocket','xhr-streaming','xhr-polling'],
            withCredentials:true
        });
        stompClient = Stomp.over(sock);
        stompClient.connect({},()=>{
            stompClient.subscribe('/user/queue/private', msg=>{
                const m = JSON.parse(msg.body);
                // 수신: m.sender는 발신자 이메일
                if(currentChatEmail && m.sender===currentChatEmail){
                    showMsg(currentChatNick, m.content);
                }
                loadRooms();
            });
        });
    }

    // 7) 메시지 전송
    sendBtn.onclick = ()=>{
        const txt = msgInput.value.trim();
        if(!txt||!currentChatEmail) return;
        const obj = { receiver:currentChatEmail, content:txt };
        stompClient.send('/pub/chat.sendPrivateMessage',{},JSON.stringify(obj));
        showMsg(currentUserNick,txt);  // 즉시 내 화면에도
        msgInput.value='';
        loadRooms();
    }

    // 메시지 화면 출력
    function showMsg(who,txt){
        const p=document.createElement('p');
        p.textContent = `${who} : ${txt}`;
        chatArea.appendChild(p);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
</script>

</body>
</html>
